apply plugin: 'java'

sourceCompatibility = '1.8'
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

if (!hasProperty('mainClass')) {
    ext.mainClass = ''
}
ext.quasarVersion = '0.5.0'
ext.comsatVersion = '0.1.1'

repositories {
    mavenLocal();
    mavenCentral()
    maven { url "https://oss.sonatype.org/content/repositories/snapshots" }
}
configurations {
    quasar
}

dependencies {
    compile "co.paralleluniverse:quasar-core:$quasarVersion"
    compile "co.paralleluniverse:comsat-servlet:$comsatVersion"
    compile "co.paralleluniverse:comsat-jax-rs-client:$comsatVersion"    
    compile 'org.eclipse.jetty.websocket:javax-websocket-server-impl:9.1.3.v20140225'
    quasar  "co.paralleluniverse:quasar-core:$quasarVersion"
}

tasks.withType(JavaExec) {
    main = mainClass
    jvmArgs "-javaagent:${configurations.quasar.iterator().next()}" // =v, =d
    jvmArgs '-server'
//    jvmArgs '-Xmx1024m'
    jvmArgs "-ea"
    classpath = sourceSets.main.runtimeClasspath   
    // systemProperty 'co.paralleluniverse.fibers.verifyInstrumentation', 'true'
}

task(runServer, dependsOn: 'classes', type: JavaExec) {
    main = 'co.paralleluniverse.examples.comsatjetty.CascadingFailureServer'
}
task(runClients, dependsOn: 'classes', type: JavaExec) {
    main = 'co.paralleluniverse.examples.comsatjetty.ClientTesters'
    systemProperty "co.paralleluniverse.cascadingfailure.host","http://localhost:8080"
    systemProperty "co.paralleluniverse.cascadingfailure.path","/regular?sleep=10"    
    systemProperty "co.paralleluniverse.cascadingfailure.rate","500"
}

defaultTasks 'runServer'
